% !TeX spellcheck = es_ES
% \documentclass[notes=onlyslideswithnotes]{beamer}
% \documentclass[handout]{beamer}
\documentclass{beamer}

%\usepackage{pgfpages}
%\pgfpagesuselayout{2 on 1}[a4paper,border shrink=5mm]
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[spanish]{babel}
\include{pygments}

\hypersetup{colorlinks=true,urlcolor=cyan,linkbordercolor=red,pdfborderstyle={/S/U/W 1}}

\mode<presentation>
{
  \usetheme{Warsaw}
  \setbeamercovered{transparent}
}


\title{Patrones de integración}
\subtitle{Apache Camel y Spring Integration}
\author[Despegar.com]{Pablo Rochás\\ \texttt{pablo.e.rochas@gmail.com}}
\date[Despegar]{Julio 2014}

% \setbeameroption{show only notes}

\begin{document}
\begin{frame}
\titlepage
\end{frame}

\section{Introducción}
\subsection{La motivación}
\begin{frame}{Integración de sistemas}
¿A qué llamamos integración de sistemas?
\note{No hay una descripción simple, se entiende al ver el ejemplo}
\end{frame}

\begin{frame}{La motivación}
Problemas de integración al escribir una aplicación
\begin{itemize}[<+->]
\item Distintas aproximaciones por programador
\item La experiencia de Ant
\item Cambios constantes y deuda técnica
\end{itemize}
\end{frame}

\subsection{Soluciones}
\begin{frame}{Soluciones}
\begin{figure}
\begin{center}
\includegraphics[scale=0.35]{TAPA}

Gregor Hohpe \& Bobby Woolf - agosto 2004
\end{center}
\end{figure}
\end{frame}

\begin{frame}{Soluciones}
\includegraphics[width= 0.9\linewidth]{camel-spring}
\note{Sp Integration es de nov 2007, Camel es de 2007 también}
\end{frame}

\begin{frame}{Componentes centrales}
\includegraphics[width=1.0\linewidth]{MessageEndpointSolution}
\note{Los encabezados perduran a través de los mensajes}
\end{frame}

\section{Ejemplos}
\subsection{mailSender}

\begin{frame}
\begin{center}
{\Large mailSender}
\end{center}
Desarrollar un sistema que envíe mails a un grupo de casillas específicas usando \textit{SMTP} para luego chequearlas usando \textit{POP3}. La idea es asegurarse que los mails lleguen al inbox y poder analizar en detalle los mails que llegan.
\end{frame}

\begin{frame}{Diseño (1) - Outbound channel adapter}
\includegraphics[width=1.0\linewidth]{sp-int-01}
\end{frame}

\begin{frame}[fragile]{Controller}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{class} \PY{n+nc}{MailSenderController}
\PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
    \PY{k+kd}{private} \PY{k+kd}{final} \PY{n}{MessagingTemplate} \PY{n}{template} \PY{o}{=} \PY{k}{new} \PY{n}{MessagingTemplate}\PY{o}{(}\PY{o}{)}\PY{o}{;}

    \PY{n+nd}{@Autowired}
    \PY{n}{MessageChannel} \PY{n}{requestChannel}\PY{o}{;}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
    
    \PY{k+kd}{private} \PY{k+kt}{long} \PY{n+nf}{processRequest}\PY{o}{(}\PY{n}{MailRequest} \PY{n}{req}\PY{o}{)}
    \PY{o}{\PYZob{}}
      \PY{c+c1}{// Arma el mail}
      \PY{k+kd}{final} \PY{n}{MimeMessage} \PY{n}{mimeMessage} \PY{o}{=} \PY{n}{mailSender}\PY{o}{.}\PY{n+na}{createMimeMessage}\PY{o}{(}\PY{o}{)}\PY{o}{;}
      \PY{o}{.}\PY{o}{.}\PY{o}{.}
      \PY{n}{Message}\PY{o}{\PYZlt{}}\PY{n}{MimeMessage}\PY{o}{\PYZgt{}} \PY{n}{mailMessage} \PY{o}{=} \PY{n}{MessageBuilder}\PY{o}{.}\PY{n+na}{withPayload}\PY{o}{(}\PY{n}{mimeMessage}\PY{o}{)}
              \PY{o}{.}\PY{n+na}{build}\PY{o}{(}\PY{o}{)}\PY{o}{;}
      \PY{n}{template}\PY{o}{.}\PY{n+na}{send}\PY{o}{(}\PY{n}{requestChannel}\PY{o}{,} \PY{n}{mailMessage}\PY{o}{)}\PY{o}{;}      
    \PY{o}{\PYZcb{}}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\end{frame}

\begin{frame}[fragile]{XML (1)}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{mail\PYZhy{}sender=}\PY{l+s}{\PYZdq{}customMailSender\PYZdq{}}\PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}bean} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}customMailSender\PYZdq{}} 
      \PY{n+na}{class=}\PY{l+s}{\PYZdq{}org.springframework.mail.javamail.JavaMailSenderImpl\PYZdq{}} \PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}property} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}defaultEncoding\PYZdq{}} \PY{n+na}{value=}\PY{l+s}{\PYZdq{}UTF\PYZhy{}8\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}property} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}javaMailProperties\PYZdq{}}\PY{n+nt}{\PYZgt{}}
        \PY{n+nt}{\PYZlt{}props}\PY{n+nt}{\PYZgt{}}
            \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.transport.protocol\PYZdq{}}\PY{n+nt}{\PYZgt{}}smtp\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
            \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.smtp.auth\PYZdq{}}\PY{n+nt}{\PYZgt{}}false\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
            \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.from\PYZdq{}}\PY{n+nt}{\PYZgt{}}bounces@despegar.com\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
            \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.debug\PYZdq{}}\PY{n+nt}{\PYZgt{}}true\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
        \PY{n+nt}{\PYZlt{}/props\PYZgt{}}
    \PY{n+nt}{\PYZlt{}/property\PYZgt{}}
\PY{n+nt}{\PYZlt{}/bean\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño (2) - Inbound channel adapter}
\includegraphics[width=0.9\linewidth]{sp-int-02}
\end{frame}

\begin{frame}[fragile]{XML (2)}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{mail\PYZhy{}sender=}\PY{l+s}{\PYZdq{}customMailSender\PYZdq{}}\PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}bean} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}customMailSender\PYZdq{}} \PY{n+na}{class=}\PY{l+s}{\PYZdq{}org.springframework.mail.javamail.JavaMailSenderImpl\PYZdq{}}\PY{n+nt}{\PYZgt{}}
...
\PY{n+nt}{\PYZlt{}/bean\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:inbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aolAdapter\PYZdq{}}
    \PY{n+na}{store\PYZhy{}uri=}\PY{l+s}{\PYZdq{}pop3://desp\PYZus{}test2\PYZpc{}40aol.com:desp123@pop.aol.com/INBOX\PYZdq{}}
    \PY{n+na}{java\PYZhy{}mail\PYZhy{}properties=}\PY{l+s}{\PYZdq{}otrosProperties\PYZdq{}}
    \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}}
    \PY{n+na}{should\PYZhy{}delete\PYZhy{}messages=}\PY{l+s}{\PYZdq{}true\PYZdq{}}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:poller} \PY{n+na}{max\PYZhy{}messages\PYZhy{}per\PYZhy{}poll=}\PY{l+s}{\PYZdq{}5\PYZdq{}} \PY{n+na}{fixed\PYZhy{}rate=}\PY{l+s}{\PYZdq{}\PYZdl{}\PYZob{}pollers.aol.rate\PYZcb{}\PYZdq{}}\PY{n+nt}{/\PYZgt{}} 
\PY{n+nt}{\PYZlt{}/int\PYZhy{}mail:inbound\PYZhy{}channel\PYZhy{}adapter\PYZgt{}}

\PY{n+nt}{\PYZlt{}util:properties} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}otrosProperties\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.pop3.socketFactory.fallback\PYZdq{}}\PY{n+nt}{\PYZgt{}}false\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
    \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.pop3.port\PYZdq{}}\PY{n+nt}{\PYZgt{}}995\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
    \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.pop3.socketFactory.class\PYZdq{}}\PY{n+nt}{\PYZgt{}}javax.net.ssl.SSLSocketFactory\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
    \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.pop3.socketFactory.port\PYZdq{}}\PY{n+nt}{\PYZgt{}}995\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
    \PY{n+nt}{\PYZlt{}prop} \PY{n+na}{key=}\PY{l+s}{\PYZdq{}mail.debug\PYZdq{}}\PY{n+nt}{\PYZgt{}}false\PY{n+nt}{\PYZlt{}/prop\PYZgt{}}
\PY{n+nt}{\PYZlt{}/util:properties\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño (2)}
\includegraphics[width=0.9\linewidth]{sp-int-03}
\end{frame}

\begin{frame}{Diseño (2)}
\includegraphics[width=0.9\linewidth]{sp-int-04}
\end{frame}

\begin{frame}{Diseño (2$\frac{1}{2}$) - Publish-Subscribe Channel}
\includegraphics[width=1.0\linewidth]{sp-int-05}
\end{frame}


\begin{frame}[fragile]{Diseño (2$\frac{1}{2}$)}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:publish\PYZhy{}subscribe\PYZhy{}channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{mail\PYZhy{}sender=}\PY{l+s}{\PYZdq{}customMailSender\PYZdq{}} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:aggregator} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{.}\PY{n+nt}{.}\PY{n+nt}{.} \PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}


\begin{frame}{Diseño (3) - Bridge}
\includegraphics[width=1.0\linewidth]{sp-int-06}
\end{frame}

\begin{frame}[fragile]{Diseño (3) - Bridge}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:publish\PYZhy{}subscribe\PYZhy{}channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{mail\PYZhy{}sender=}\PY{l+s}{\PYZdq{}customMailSender\PYZdq{}} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}bean} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}customMailSender\PYZdq{}} \PY{n+na}{class=}\PY{l+s}{\PYZdq{}o.s.mail.javamail.JavaMailSenderImpl\PYZdq{}}\PY{n+nt}{\PYZgt{}}
...
\PY{n+nt}{\PYZlt{}/bean\PYZgt{}} 

\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:inbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aolAdapter\PYZdq{}}
    \PY{n+na}{store\PYZhy{}uri=}\PY{l+s}{\PYZdq{}pop3://desp\PYZus{}test2\PYZpc{}40aol.com:desp123@pop.aol.com/INBOX\PYZdq{}}
    \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{.}\PY{n+nt}{.}\PY{n+nt}{.} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:bridge} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:aggregator} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{.}\PY{n+nt}{.}\PY{n+nt}{.} \PY{n+nt}{/\PYZgt{}}
\end{Verbatim}

\end{frame}

\begin{frame}{Diseño (4) - Aggregator}
Definiciones para el aggregator
\begin{enumerate}[<+->]
\item A qué grupo pertenece un mensaje
\item Cuándo está completo el grupo
\item Cómo armo el mensaje de salida con el grupo completo
\end{enumerate}
\end{frame}

\begin{frame}[fragile]{Diseño (4) - Aggregator XML}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:aggregator} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}matchedChannel\PYZdq{}} 
                \PY{n+na}{ref=}\PY{l+s}{\PYZdq{}mailAggregator\PYZdq{}} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}bean} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}mailAggregator\PYZdq{}} \PY{n+na}{class=}\PY{l+s}{\PYZdq{}com.despegar.mailsender.MailSenderAggregator\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}[fragile]{Diseño (4) - Aggregator Java}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{class} \PY{n+nc}{MailSenderAggregator} \PY{o}{\PYZob{}}
  \PY{o}{.}\PY{o}{.}\PY{o}{.}

  \PY{n+nd}{@CorrelationStrategy}
  \PY{k+kd}{public} \PY{n}{String} \PY{n+nf}{correlateBy}\PY{o}{(}\PY{n}{MimeMessage} \PY{n}{item}\PY{o}{)} \PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
  \PY{o}{\PYZcb{}}

  \PY{n+nd}{@ReleaseStrategy}
  \PY{k+kd}{public} \PY{k+kt}{boolean} \PY{n+nf}{releaseChecker}\PY{o}{(}\PY{n}{List}\PY{o}{\PYZlt{}}\PY{n}{Message}\PY{o}{\PYZlt{}}\PY{o}{?}\PY{o}{\PYZgt{}}\PY{o}{\PYZgt{}} \PY{n}{messages}\PY{o}{)} \PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
  \PY{o}{\PYZcb{}}

  \PY{n+nd}{@Aggregator}
  \PY{k+kd}{public} \PY{n}{Object} \PY{n+nf}{aggregatingMethod}\PY{o}{(}\PY{n}{List}\PY{o}{\PYZlt{}}\PY{n}{Message}\PY{o}{\PYZlt{}}\PY{o}{?}\PY{o}{\PYZgt{}}\PY{o}{\PYZgt{}} \PY{n}{messages}\PY{o}{)} \PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
  \PY{o}{\PYZcb{}}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño (5)}
Para nuestra aplicación
\begin{enumerate}[<+->]
\item Agrupamos mail por un encabezado MIME
\item Un grupo está completo cuando tenemos dos mail
\item Como salida, queremos el mail que llegó para analizarlo
\end{enumerate}
\begin{center}
\pause
¿Cómo distinguimos el mail enviado del recibido?
\end{center}
\end{frame}

\begin{frame}{Diseño (5) - Header enricher}
\includegraphics[width=1.0\linewidth]{sp-int-07}
\end{frame}


\begin{frame}[fragile]{Diseño (5) - Header enricher}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{class} \PY{n+nc}{MailSenderController}
\PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
    \PY{k+kd}{private} \PY{k+kd}{final} \PY{n}{MessagingTemplate} \PY{n}{template} \PY{o}{=} \PY{k}{new} \PY{n}{MessagingTemplate}\PY{o}{(}\PY{o}{)}\PY{o}{;}

    \PY{n+nd}{@Autowired}
    \PY{n}{MessageChannel} \PY{n}{sendChannel}\PY{o}{;}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}

    \PY{k+kd}{private} \PY{k+kt}{long} \PY{n+nf}{processRequest}\PY{o}{(}\PY{n}{MailRequest} \PY{n}{req}\PY{o}{)}
    \PY{o}{\PYZob{}}
         \PY{c+c1}{// Arma el mail}
         \PY{k+kd}{final} \PY{n}{MimeMessage} \PY{n}{mimeMessage} \PY{o}{=} \PY{n}{mailSender}\PY{o}{.}\PY{n+na}{createMimeMessage}\PY{o}{(}\PY{o}{)}\PY{o}{;}
         \PY{o}{.}\PY{o}{.}\PY{o}{.}
         \PY{n}{mimeMessage}\PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{l+s}{\PYZdq{}X\PYZhy{}Mailchecker\PYZdq{}}\PY{o}{,} \PY{n}{reqId}\PY{o}{)}\PY{o}{;}
         \PY{o}{.}\PY{o}{.}\PY{o}{.}
         \PY{n}{Message}\PY{o}{\PYZlt{}}\PY{n}{MimeMessage}\PY{o}{\PYZgt{}} \PY{n}{mailMessage} \PY{o}{=} \PY{n}{MessageBuilder}\PY{o}{.}\PY{n+na}{withPayload}\PY{o}{(}\PY{n}{mimeMessage}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{MATCH\PYZus{}TYPE}\PY{o}{,} \PY{l+s}{\PYZdq{}sent\PYZdq{}}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{REQUEST\PYZus{}ID}\PY{o}{,} \PY{n}{reqId}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{build}\PY{o}{(}\PY{o}{)}\PY{o}{;}
         \PY{n}{template}\PY{o}{.}\PY{n+na}{send}\PY{o}{(}\PY{n}{sendChannel}\PY{o}{,} \PY{n}{mailMessage}\PY{o}{)}\PY{o}{;}
    \PY{o}{\PYZcb{}}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\note{No confundir los headers MIME con los de Integration}
\end{frame}

\begin{frame}[fragile]{Diseño (5) - Header enricher}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:inbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aolAdapter\PYZdq{}}
    \PY{n+na}{store\PYZhy{}uri=}\PY{l+s}{\PYZdq{}pop3://desp\PYZus{}test2\PYZpc{}40aol.com:desp123@pop.aol.com/INBOX\PYZdq{}}
    \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}} \PY{n+nt}{.}\PY{n+nt}{.}\PY{n+nt}{.} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:header\PYZhy{}enricher} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:header} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}mailchecker\PYZus{}match\PYZus{}type\PYZdq{}} \PY{n+na}{value=}\PY{l+s}{\PYZdq{}received\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:header} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}mailchecker\PYZus{}id\PYZdq{}} 
        \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}payload.getHeader(\PYZsq{}X\PYZhy{}Mailchecker\PYZsq{})\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:header\PYZhy{}enricher\PYZgt{}}
\end{Verbatim}
\note{Comentario sobre SpEL}
\end{frame}

\begin{frame}{Diseño}
Se debe modificar el código Java del Aggregator para manejar los \textit{headers}. \pause

Con esto hecho, ya podemos distinguir el mail que llega para analizarlo.
Para ello, guardaremos el contenido como archivo.
\end{frame}

\begin{frame}{Diseño (6) - File Outbound Channel Adapter}
\includegraphics[width=1.0\linewidth]{sp-int-08}
\end{frame}

\begin{frame}{Diseño (6) - File Outbound Channel Adapter}
\includegraphics[width=0.9\linewidth]{sp-int-10b}
\end{frame}

\begin{frame}[fragile]{Diseño (6) - File Outbound Channel Adapter}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:aggregator} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}matchedChannel\PYZdq{}} 
                \PY{n+na}{ref=}\PY{l+s}{\PYZdq{}mailAggregator\PYZdq{}} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}matchedChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}file:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}matchedChannel\PYZdq{}} \PY{n+na}{directory=}\PY{l+s}{\PYZdq{}file:results/matched\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño (6) - Transformer}
\includegraphics[width=1.0\linewidth]{sp-int-11b}
\end{frame}

\begin{frame}[fragile]{Diseño (6) - Transformer}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{class} \PY{n+nc}{MimeMessageToStringTransformer} \PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
    \PY{n+nd}{@Transformer}
    \PY{k+kd}{public} \PY{n}{String} \PY{n+nf}{transformMail}\PY{o}{(}\PY{n}{MimeMessage} \PY{n}{mm}\PY{o}{)} \PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
    \PY{o}{\PYZcb{}}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño (7) - Chain}
\includegraphics[width=1.0\linewidth]{sp-int-12b}
\end{frame}

\begin{frame}[fragile]{Diseño (7) - Chain}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:aggregator} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}matchedChannel\PYZdq{}} 
                \PY{n+na}{ref=}\PY{l+s}{\PYZdq{}mailAggregator\PYZdq{}} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:chain} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}matchedChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}fileMatchedChannel\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:transformer}\PY{n+nt}{\PYZgt{}}
        \PY{n+nt}{\PYZlt{}bean} \PY{n+na}{class=}\PY{l+s}{\PYZdq{}com.despegar.checkmail.integration.MimeMessageToStringTransformer\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}/int:transformer\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:header\PYZhy{}enricher}\PY{n+nt}{\PYZgt{}}
        \PY{n+nt}{\PYZlt{}int:header} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}file\PYZus{}name\PYZdq{}} \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}headers[\PYZsq{}mailchecker\PYZus{}id\PYZsq{}] + \PYZsq{}.msg\PYZsq{}\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}/int:header\PYZhy{}enricher\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:chain\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}fileMatchedChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}file:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}matchedChannel\PYZdq{}} \PY{n+na}{directory=}\PY{l+s}{\PYZdq{}file:results/matched\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño - Caso feliz}
\includegraphics[width=1.0\linewidth]{sp-int-12b}
\end{frame}

% explicar que puede haber varias casillas de mail como haga falta

\begin{frame}{Diseño - Casos no felices}
\begin{itemize}
\item Mails que no llegan
\item Mail que no fueron generados por la aplicación y no tienen el encabezado MIME
\end{itemize}
\end{frame}

\begin{frame}{Diseño - Casos no felices}
Para manejar estos casos, necesitamos indicarle al Aggregator que los mensajes que no forman grupo en un determinado tiempo deben descartarse.
\note{No es la forma más prolija pero sirve para tocar un tema interesante}
\end{frame}

\begin{frame}[fragile]{Diseño - Aggregator (Message Store)}
¿Dónde guarda los mensajes el Aggregator?
\pause
\begin{center}
\verb|MessageStore|
\end{center}
\begin{itemize}[<+->]
\item Implementación en memoria (\verb|SimpleMessageStore|)
\item Otras implementaciones interesantes: JDBC, Mongo, Redis
\item Se puede hacer un implementación propia
\item Los \verb|MessageStore| tienen manera de purgar grupos de mensajes por timeout (\verb|MessageGroupStoreReaper|)
\end{itemize}
\note{En la version mas nueva es más fácil de indicar}
\end{frame}

\begin{frame}[fragile]{Aggregator - Message Store}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:aggregator} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}matchedChannel\PYZdq{}} 
                \PY{n+na}{ref=}\PY{l+s}{\PYZdq{}mailAggregator\PYZdq{}} 
                \PY{n+na}{discard\PYZhy{}channel=}\PY{l+s}{\PYZdq{}throwAwayChannel\PYZdq{}} 
                \PY{n+na}{message\PYZhy{}store=}\PY{l+s}{\PYZdq{}aggregatorMessageStore\PYZdq{}} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}bean} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorMessageStore\PYZdq{}} \PY{n+na}{class=}\PY{l+s}{\PYZdq{}org.springframework.integration.store.SimpleMessageStore\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}bean} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorReaper\PYZdq{}} \PY{n+na}{class=}\PY{l+s}{\PYZdq{}org.springframework.integration.store.MessageGroupStoreReaper\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}property} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}messageGroupStore\PYZdq{}} \PY{n+na}{ref=}\PY{l+s}{\PYZdq{}aggregatorMessageStore\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}property} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}timeout\PYZdq{}} \PY{n+na}{value=}\PY{l+s}{\PYZdq{}\PYZdl{}\PYZob{}matcher.reaper.delay\PYZcb{}\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}/bean\PYZgt{}}

\PY{n+nt}{\PYZlt{}task:scheduled\PYZhy{}tasks}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}task:scheduled} \PY{n+na}{ref=}\PY{l+s}{\PYZdq{}aggregatorReaper\PYZdq{}} \PY{n+na}{method=}\PY{l+s}{\PYZdq{}run\PYZdq{}} \PY{n+na}{fixed\PYZhy{}rate=}\PY{l+s}{\PYZdq{}10000\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}/task:scheduled\PYZhy{}tasks\PYZgt{}}
\end{Verbatim}
\end{frame}


\begin{frame}[fragile]{Diseño - Caso no feliz}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:chain} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}throwAwayChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}fileThrowAwayChannel\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:transformer}\PY{n+nt}{\PYZgt{}}
        \PY{n+nt}{\PYZlt{}bean} \PY{n+na}{class=}\PY{l+s}{\PYZdq{}com.despegar.checkmail.integration.MimeMessageToStringTransformer\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}/int:transformer\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:header\PYZhy{}enricher}\PY{n+nt}{\PYZgt{}}
        \PY{n+nt}{\PYZlt{}int:header} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}file\PYZus{}name\PYZdq{}} \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}headers[\PYZsq{}timestamp\PYZsq{}] + }
\PY{l+s}{                    \PYZsq{}\PYZhy{}\PYZsq{} + headers[\PYZsq{}mailchecker\PYZus{}match\PYZus{}type\PYZsq{}] + \PYZsq{}.msg\PYZsq{}\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}/int:header\PYZhy{}enricher\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:chain\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}fileThrowAwayChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}file:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}fileThrowAwayChannel\PYZdq{}} \PY{n+na}{directory=}\PY{l+s}{\PYZdq{}file:results/throwAway\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}[fragile]{Diseño - Caso no feliz}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:inbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aolAdapter\PYZdq{}}
    \PY{n+na}{store\PYZhy{}uri=}\PY{l+s}{\PYZdq{}pop3://desp\PYZus{}test2\PYZpc{}40aol.com:desp123@pop.aol.com/INBOX\PYZdq{}}
    \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}} \PY{n+nt}{.}\PY{n+nt}{.}\PY{n+nt}{.} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:header\PYZhy{}enricher} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:header} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}mailchecker\PYZus{}match\PYZus{}type\PYZdq{}} \PY{n+na}{value=}\PY{l+s}{\PYZdq{}received\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:header} \PY{n+na}{name=}\PY{l+s}{\PYZdq{}mailchecker\PYZus{}id\PYZdq{}} 
        \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}payload.getHeader(\PYZsq{}X\PYZhy{}Mailchecker\PYZsq{}, null) ?: }
\PY{l+s}{                    \PYZsq{}nogroup\PYZsq{} + new java.util.Random().nextInt()\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:header\PYZhy{}enricher\PYZgt{}}

\end{Verbatim}
\end{frame}

\begin{frame}{Diseño - Caso feliz y no feliz}
\includegraphics[width=1.0\linewidth]{sp-int-12}
\end{frame}

\begin{frame}{Diseño - Más de un SMTP}
\begin{center}
\Large{Cambio de requerimiento}
\end{center}
Ahora puede haber más de un servidor SMTP por el que quiera enviar los mails. El servidor elegido se indica en el formulario web.
\end{frame}

\begin{frame}{Diseño - Más de un SMTP}
\includegraphics[width=1.0\linewidth]{sp-int-13}
\end{frame}

\begin{frame}[fragile]{Diseño - Más de un SMTP}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{class} \PY{n+nc}{MailSenderController}
\PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
    \PY{k+kd}{private} \PY{k+kd}{final} \PY{n}{MessagingTemplate} \PY{n}{template} \PY{o}{=} \PY{k}{new} \PY{n}{MessagingTemplate}\PY{o}{(}\PY{o}{)}\PY{o}{;}

    \PY{n+nd}{@Autowired}
    \PY{n}{MessageChannel} \PY{n}{sendChannel}\PY{o}{;}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}

    \PY{k+kd}{private} \PY{k+kt}{long} \PY{n+nf}{processRequest}\PY{o}{(}\PY{n}{MailRequest} \PY{n}{req}\PY{o}{)}
    \PY{o}{\PYZob{}}
         \PY{c+c1}{// Arma el mail}
         \PY{k+kd}{final} \PY{n}{MimeMessage} \PY{n}{mimeMessage} \PY{o}{=} \PY{n}{mailSender}\PY{o}{.}\PY{n+na}{createMimeMessage}\PY{o}{(}\PY{o}{)}\PY{o}{;}
         \PY{o}{.}\PY{o}{.}\PY{o}{.}
         \PY{n}{mimeMessage}\PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{l+s}{\PYZdq{}X\PYZhy{}Mailchecker\PYZdq{}}\PY{o}{,} \PY{n}{reqId}\PY{o}{)}\PY{o}{;}
         \PY{o}{.}\PY{o}{.}\PY{o}{.}
         \PY{n}{Message}\PY{o}{\PYZlt{}}\PY{n}{MimeMessage}\PY{o}{\PYZgt{}} \PY{n}{mailMessage} \PY{o}{=} \PY{n}{MessageBuilder}\PY{o}{.}\PY{n+na}{withPayload}\PY{o}{(}\PY{n}{mimeMessage}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{MATCH\PYZus{}TYPE}\PY{o}{,} \PY{l+s}{\PYZdq{}sent\PYZdq{}}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{REQUEST\PYZus{}ID}\PY{o}{,} \PY{n}{reqId}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{SENDER}\PY{o}{,} \PY{n}{sender}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{build}\PY{o}{(}\PY{o}{)}\PY{o}{;}
         \PY{n}{template}\PY{o}{.}\PY{n+na}{send}\PY{o}{(}\PY{n}{sendChannel}\PY{o}{,} \PY{n}{mailMessage}\PY{o}{)}\PY{o}{;}
    \PY{o}{\PYZcb{}}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\end{frame}

\begin{frame}[fragile]{Diseño - Más de un SMTP}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:publish\PYZhy{}subscribe\PYZhy{}channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:header\PYZhy{}value\PYZhy{}router} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{header\PYZhy{}name=}\PY{l+s}{\PYZdq{}mailchecker\PYZus{}sender\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:mapping} \PY{n+na}{value=}\PY{l+s}{\PYZdq{}mailSender1\PYZdq{}} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}sender1Channel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:mapping} \PY{n+na}{value=}\PY{l+s}{\PYZdq{}mailSender2\PYZdq{}} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}sender2Channel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:header\PYZhy{}value\PYZhy{}router\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}sender1Channel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}sender1Channel\PYZdq{}} \PY{n+na}{mail\PYZhy{}sender=}\PY{l+s}{\PYZdq{}mailSender1\PYZdq{}}\PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}sender2Channel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:outbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}sender2Channel\PYZdq{}} \PY{n+na}{mail\PYZhy{}sender=}\PY{l+s}{\PYZdq{}mailSender2\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño - Más de un SMTP}
\includegraphics[width=1.0\linewidth]{sp-int-13}
\end{frame}

\begin{frame}{Diseño - Empezar / detener polling}
\begin{center}
\Large{Cambio de requerimiento}
\end{center}
El sistema debe empezar a hacer \textit{polling} solamente cuando envía mails y debe detenerse luego de unos minutos.
\end{frame}

\begin{frame}[fragile]{Diseño - Empezar / detener polling}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{class} \PY{n+nc}{MailSenderController}
\PY{o}{\PYZob{}}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}
    \PY{k+kd}{private} \PY{k+kd}{final} \PY{n}{MessagingTemplate} \PY{n}{template} \PY{o}{=} \PY{k}{new} \PY{n}{MessagingTemplate}\PY{o}{(}\PY{o}{)}\PY{o}{;}

    \PY{n+nd}{@Autowired}
    \PY{n}{MessageChannel} \PY{n}{sendChannel}\PY{o}{;}
    \PY{o}{.}\PY{o}{.}\PY{o}{.}

    \PY{k+kd}{private} \PY{k+kt}{long} \PY{n+nf}{processRequest}\PY{o}{(}\PY{n}{MailRequest} \PY{n}{req}\PY{o}{)}
    \PY{o}{\PYZob{}}
         \PY{c+c1}{// Arma el mail}
         \PY{k+kd}{final} \PY{n}{MimeMessage} \PY{n}{mimeMessage} \PY{o}{=} \PY{n}{mailSender}\PY{o}{.}\PY{n+na}{createMimeMessage}\PY{o}{(}\PY{o}{)}\PY{o}{;}
         \PY{o}{.}\PY{o}{.}\PY{o}{.}
         \PY{n}{mimeMessage}\PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{l+s}{\PYZdq{}X\PYZhy{}Mailchecker\PYZdq{}}\PY{o}{,} \PY{n}{reqId}\PY{o}{)}\PY{o}{;}
         \PY{o}{.}\PY{o}{.}\PY{o}{.}
         \PY{n}{Message}\PY{o}{\PYZlt{}}\PY{n}{MimeMessage}\PY{o}{\PYZgt{}} \PY{n}{mailMessage} \PY{o}{=} \PY{n}{MessageBuilder}\PY{o}{.}\PY{n+na}{withPayload}\PY{o}{(}\PY{n}{mimeMessage}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{MATCH\PYZus{}TYPE}\PY{o}{,} \PY{l+s}{\PYZdq{}sent\PYZdq{}}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{REQUEST\PYZus{}ID}\PY{o}{,} \PY{n}{reqId}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{SENDER}\PY{o}{,} \PY{n}{sender}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{setHeader}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{POLLER}\PY{o}{,} \PY{n}{poller}\PY{o}{)}
         \PY{o}{.}\PY{n+na}{build}\PY{o}{(}\PY{o}{)}\PY{o}{;}
         \PY{n}{template}\PY{o}{.}\PY{n+na}{send}\PY{o}{(}\PY{n}{sendChannel}\PY{o}{,} \PY{n}{mailMessage}\PY{o}{)}\PY{o}{;}
    \PY{o}{\PYZcb{}}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño - Empezar / detener polling}
\includegraphics[width=0.9\linewidth]{sp-int-14}
\end{frame}

\begin{frame}[fragile]{Diseño - Empezar / detener polling}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int\PYZhy{}mail:inbound\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aolAdapter\PYZdq{}}
    \PY{n+na}{store\PYZhy{}uri=}\PY{l+s}{\PYZdq{}pop3://desp\PYZus{}test2\PYZpc{}40aol.com:desp123@pop.aol.com/INBOX\PYZdq{}}
    \PY{n+na}{auto\PYZhy{}startup=}\PY{l+s}{\PYZdq{}false\PYZdq{}}
    \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}receiveChannel\PYZdq{}} \PY{n+nt}{.}\PY{n+nt}{.}\PY{n+nt}{.} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:transformer} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}controlChannel\PYZdq{}}
                 \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}\PYZsq{}@\PYZsq{} + headers[\PYZsq{}mailchecker\PYZus{}poller\PYZsq{}] + \PYZsq{}.start()\PYZsq{}\PYZdq{}}\PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}controlChannel\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:control\PYZhy{}bus} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}controlChannel\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño - Empezar / detener polling}
\includegraphics[width=0.8\linewidth]{sp-int-14a}
\end{frame}

\begin{frame}[fragile]{Diseño - Empezar / detener polling}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:transformer} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}controlChannel\PYZdq{}}
                 \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}\PYZsq{}@\PYZsq{} + headers[\PYZsq{}mailchecker\PYZus{}poller\PYZsq{}] + \PYZsq{}.start()\PYZsq{}\PYZdq{}}\PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:chain} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}controlBusChannel\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:delayer} \PY{n+na}{default\PYZhy{}delay=}\PY{l+s}{\PYZdq{}\PYZdl{}\PYZob{}pollers.stop.delay\PYZcb{}\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:transformer} \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}\PYZsq{}@\PYZsq{} + headers[\PYZsq{}mailchecker\PYZus{}poller\PYZsq{}] + \PYZsq{}.stop()\PYZsq{}\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:chain\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}controlChannel\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:control\PYZhy{}bus} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}controlChannel\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño - Empezar / detener polling}
Algunos proveedores de servicio (en particular Hotmail) no permiten hacer \textit{polling} más seguido de 15min. Por lo que si se empieza a hacer \textit{polling} ni bien se hace el envío, no da la oportunidad de llegar al mail y tengo que esperar innecesariamente.
\end{frame}

\begin{frame}{Diseño - Empezar / detener polling}
\includegraphics[width=0.8\linewidth]{sp-int-15}
\end{frame}

\begin{frame}[fragile]{Diseño - Empezar / detener polling}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:chain} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}controlBusChannel\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:delayer} \PY{n+na}{default\PYZhy{}delay=}\PY{l+s}{\PYZdq{}\PYZdl{}\PYZob{}pollers.start.delay\PYZcb{}\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:transformer} \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}\PYZsq{}@\PYZsq{} + headers[\PYZsq{}mailchecker\PYZus{}poller\PYZsq{}] + \PYZsq{}.start()\PYZsq{}\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:chain\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:chain} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+na}{output\PYZhy{}channel=}\PY{l+s}{\PYZdq{}controlBusChannel\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:delayer} \PY{n+na}{default\PYZhy{}delay=}\PY{l+s}{\PYZdq{}\PYZsh{}\PYZob{}\PYZdl{}\PYZob{}pollers.start.delay\PYZcb{} + \PYZdl{}\PYZob{}matcher.reaper.delay\PYZcb{} + 60000\PYZcb{}\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:transformer} \PY{n+na}{expression=}\PY{l+s}{\PYZdq{}\PYZsq{}@\PYZsq{} + headers[\PYZsq{}mailchecker\PYZus{}poller\PYZsq{}] + \PYZsq{}.stop()\PYZsq{}\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:chain\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}controlChannel\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:control\PYZhy{}bus} \PY{n+na}{input\PYZhy{}channel=}\PY{l+s}{\PYZdq{}controlChannel\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}{Diseño final}
\includegraphics[width=0.7\linewidth]{sp-int-99}
\end{frame}

\subsection{Consideraciones}
\begin{frame}{Consideraciones}
\begin{itemize}
\item \textit{Debug} y \textit{logging}
\item Manejo de excepciones y errores
\item Transacciones
\item \textit{Gateways}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Debug y logging: Log adapter}

{\small XML}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}logChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\PY{n+nt}{\PYZlt{}int:logging\PYZhy{}channel\PYZhy{}adapter} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}logChannel\PYZdq{}} \PY{n+na}{level=}\PY{l+s}{\PYZdq{}INFO\PYZdq{}} \PY{n+na}{log\PYZhy{}full\PYZhy{}message=}\PY{l+s}{\PYZdq{}true\PYZdq{}} 
        \PY{n+na}{logger\PYZhy{}name=}\PY{l+s}{\PYZdq{}int\PYZhy{}logger\PYZhy{}aggregator\PYZdq{}} \PY{n+nt}{/\PYZgt{}}

\PY{n+nt}{\PYZlt{}int:channel} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}aggregatorChannel\PYZdq{}}\PY{n+nt}{\PYZgt{}}
    \PY{n+nt}{\PYZlt{}int:interceptors}\PY{n+nt}{\PYZgt{}}
        \PY{n+nt}{\PYZlt{}int:wire\PYZhy{}tap} \PY{n+na}{channel=}\PY{l+s}{\PYZdq{}logChannel\PYZdq{}}\PY{n+nt}{/\PYZgt{}}
    \PY{n+nt}{\PYZlt{}/int:interceptors\PYZgt{}}
\PY{n+nt}{\PYZlt{}/int:channel\PYZgt{}}
\end{Verbatim}

{\small log}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
INFO [task\PYZhy{}scheduler\PYZhy{}4] \PYZhy{}\PYZhy{}\PYZhy{} int\PYZhy{}logger\PYZhy{}aggregator: [Payload=org.springframework.integration.mail.
AbstractMailReceiver\PYZdl{}IntegrationMimeMessage@563da1dc][Headers=\PYZob{}timestamp=1403616633740,
id=aa5d54ac\PYZhy{}f4f0\PYZhy{}6217\PYZhy{}32ce\PYZhy{}5ea5dbc706ad, mailchecker\PYZus{}id=nogroup\PYZhy{}1605819369,
mailchecker\PYZus{}match\PYZus{}type=received\PYZcb{}]
\end{Verbatim}
\end{frame}

\begin{frame}[fragile]{Debug y logging: Message history}
\begin{center}
Message history
\end{center}
{\small XML}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:message\PYZhy{}history}\PY{n+nt}{/\PYZgt{}}
\end{Verbatim}

{\small log}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
INFO [task\PYZhy{}scheduler\PYZhy{}4] \PYZhy{}\PYZhy{}\PYZhy{} int\PYZhy{}logger\PYZhy{}aggregator: [Payload=org.springframework.integration.mail.
AbstractMailReceiver\PYZdl{}IntegrationMimeMessage@563da1dc][Headers=\PYZob{}timestamp=1403616633740, id=aa5d54ac\PYZhy{}f4f0\PYZhy{}6217\PYZhy{}32ce\PYZhy{}5ea5dbc706ad,
\textcolor{red}{history=yahooFrAdapter,receiveChannel,aggregatorChannel,logChannel,logChannel.adapter},
mailchecker\PYZus{}id=nogroup\PYZhy{}1605819369, mailchecker\PYZus{}match\PYZus{}type=received\PYZcb{}]
\end{Verbatim}
\end{frame}

\begin{frame}[fragile]{Teoría}
\begin{center}
¿Qué diferencia hay entre \verb|wire-tap| y \verb|publish-subscribe-channel|?
\end{center}
\begin{center}
\includegraphics[width=0.5\linewidth]{sp-int-20}
\end{center}
\end{frame}

\begin{frame}[fragile]{Debug y logging}
\begin{itemize}[<+->]
\item Cada módulo es más fácil de probar independientemente 
\item No se puede encontrar todo con \textit{logging}: \verb|MailToStringTransformer|.
\item \textit{Use the source, Luke} 
\end{itemize}
\end{frame}

\begin{frame}{Excepciones y errores}
\begin{center}
{\large Manejo de excepciones}
\end{center}
\begin{itemize}
\item \textit{Thread} de invocación al framework
\item \textit{Thread} independiente (cron, polling, etc)
\end{itemize}
\end{frame}

\begin{frame}{Excepciones y errores}
\includegraphics[width=0.7\linewidth]{sp-int-99}
\end{frame}

\begin{frame}{Excepciones y errores}
\par
{\large Dead letter channel}
\begin{itemize}
\item Si no se define explícitamente, se define un \textit{errorChannel} como publish-subscribe con un logger adapter suscrito
\end{itemize}
\begin{center}
\includegraphics[width=0.2\linewidth]{sp-int-21}
\end{center}
\end{frame}

\begin{frame}[fragile]{Excepciones y errores}
\begin{itemize}[<+->]
\item En ambos casos, la excepción se devuelve como \verb|o.s.i.MessagingException|. En particular, los mensajes no entregados se devuelven como \verb|o.s.i.MessageHandlingException|.
\item Framework de reintentos
\end{itemize}
\end{frame}


\begin{frame}{Transacciones}
\begin{itemize}
\item Poca documentación y ejemplos
\item Se puede manejar explícitamente
\end{itemize}
\end{frame}

\begin{frame}{Gateways}
\par
\begin{center}
{\Large Gateways}
\end{center}
El propósito principal del Gateway es ocultar la implementación hecha con mensajes, simplificando la integración con el resto del sistema.
\end{frame}

\begin{frame}[fragile]{Gateways}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{class} \PY{n+nc}{MailSenderController}
\PY{o}{\PYZob{}}
    \PY{c+c1}{// ...}
    \PY{n+nd}{@Autowired}
    \PY{n}{MailSender} \PY{n}{mailSender}\PY{o}{;}
    \PY{c+c1}{// ...}
    
    \PY{k+kd}{private} \PY{k+kt}{long} \PY{n+nf}{processRequest}\PY{o}{(}\PY{n}{MailRequest} \PY{n}{req}\PY{o}{)}
    \PY{o}{\PYZob{}}
        \PY{k}{for} \PY{o}{(}\PY{n}{String} \PY{n}{mailAccount} \PY{o}{:} \PY{n}{mailRequest}\PY{o}{.}\PY{n+na}{getMailAccounts}\PY{o}{(}\PY{o}{)}\PY{o}{)}
        \PY{o}{\PYZob{}}
            \PY{c+c1}{// Arma el mail}
            \PY{k+kd}{final} \PY{n}{MimeMessage} \PY{n}{mimeMessage} \PY{o}{=} \PY{n}{mailSender}\PY{o}{.}\PY{n+na}{createMimeMessage}\PY{o}{(}\PY{o}{)}\PY{o}{;}
            \PY{c+c1}{// ...}
            \PY{n}{mailSender}\PY{o}{.}\PY{n+na}{sendMail}\PY{o}{(}\PY{n}{reqId}\PY{o}{,} \PY{n}{smtpId}\PY{o}{,} \PY{n}{poller}\PY{o}{,} \PY{n}{mimeMessage}\PY{o}{)}\PY{o}{;}
        \PY{o}{\PYZcb{}}
    \PY{o}{\PYZcb{}}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\end{frame}


\begin{frame}[fragile]{Gateways}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{interface} \PY{n+nc}{MailSender}
\PY{o}{\PYZob{}}
    \PY{k+kd}{public} \PY{k+kt}{void} \PY{n+nf}{sendMail}\PY{o}{(}\PY{n}{String} \PY{n}{reqId}\PY{o}{,} \PY{n}{String} \PY{n}{sender}\PY{o}{,} \PY{n}{String} \PY{n}{poller}\PY{o}{,} \PY{n}{MimeMessage} \PY{n}{mimeMessage}\PY{o}{)}\PY{o}{;}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\end{frame}


\begin{frame}[fragile]{Gateways}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{n+nt}{\PYZlt{}int:gateway} \PY{n+na}{id=}\PY{l+s}{\PYZdq{}mailSender\PYZdq{}} \PY{n+na}{service\PYZhy{}interface=}\PY{l+s}{\PYZdq{}com.despegar.checkmail.integration.MailSender\PYZdq{}} 
                             \PY{n+na}{default\PYZhy{}request\PYZhy{}channel=}\PY{l+s}{\PYZdq{}requestChannel\PYZdq{}} \PY{n+nt}{/\PYZgt{}}
\end{Verbatim}
\end{frame}

\begin{frame}[fragile]{Gateways}
\begin{Verbatim}[fontsize=\tiny,commandchars=\\\{\}]
\PY{k+kd}{public} \PY{k+kd}{interface} \PY{n+nc}{MailSender}
\PY{o}{\PYZob{}}
    \PY{n+nd}{@Gateway}\PY{o}{(}\PY{n}{requestChannel} \PY{o}{=} \PY{l+s}{\PYZdq{}requestChannel\PYZdq{}}\PY{o}{)}
    \PY{k+kd}{public} \PY{k+kt}{void} \PY{n+nf}{sendMail}\PY{o}{(}\PY{n+nd}{@Header}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{REQUEST\PYZus{}ID}\PY{o}{)} \PY{n}{String} \PY{n}{reqId}\PY{o}{,}
            \PY{n+nd}{@Header}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{SENDER}\PY{o}{)} \PY{n}{String} \PY{n}{sender}\PY{o}{,}
            \PY{n+nd}{@Header}\PY{o}{(}\PY{n}{MailCheckerHeaders}\PY{o}{.}\PY{n+na}{POLLER}\PY{o}{)} \PY{n}{String} \PY{n}{poller}\PY{o}{,} \PY{n}{MimeMessage} \PY{n}{mimeMessage}\PY{o}{)}\PY{o}{;}
\PY{o}{\PYZcb{}}
\end{Verbatim}
\end{frame}

\subsection{Subscriptions API v3}
\begin{frame}
\begin{center}
\Large{Subscriptions API v3}
\end{center}
Desarrollar un caso de uso del sistema que reciba información sobre un grupo de alertas de un cliente y las persista asociadas a él.
\end{frame}

\begin{frame}{agregar alerta}
\begin{center}
\includegraphics[width=0.4\linewidth]{sp-int-25}
\end{center}
\end{frame}

\begin{frame}{agregar alerta}
\begin{center}
\includegraphics[width=0.4\linewidth]{sp-int-26}
\end{center}
\end{frame}

\begin{frame}{agregar alerta}
\begin{center}
\includegraphics[width=0.6\linewidth]{sp-int-27}
\end{center}
\end{frame}

\begin{frame}{agregar alerta}
\includegraphics[width=0.9\linewidth]{sp-int-28}
\end{frame}

\begin{frame}{agregar alerta}
\includegraphics[width=1.0\linewidth]{sp-int-29}
\end{frame}

\begin{frame}{agregar alerta}
\includegraphics[width=1.1\linewidth]{sp-int-30}
\end{frame}

\subsection{Consideraciones}

\begin{frame}
\begin{center}
\Large{¿¿ y Apache Camel ??}
\note{Spring es más Riquelme-dependiente y más ajustado al libro. \par }
\note{Camel es más flexible, fácil de hacer debug, se ajusta mejor al programador}
\end{center}
\end{frame}

% tapa del libro de EIP
% Se edito en agosto 2004
% los frameworks en Sp 11/2007, cam 2007
% Diferencias entre las implementaciones:
% - Spring mucho mas cercano al libro
% - Camel mas cómodo y flexible para el programador, se ajusta a su manera de programar
% El ejemplo se desarrolla con spring
% no es la panacea
% preambulo ejemplo: endpoint, channel, message
% ejemplo mail sender
% casos especiales: excepciones, transacciones
% endpoints y/o canales interesantes para destacar (jdbc inbound ch adapter, jpa outbound gateway, etc)
% subscriptions api v3
% wiretap, gateway con java
% retry framework
% conclusiones: no es necesario usar una implementacion, se trata de aprender el lenguaje comun
\begin{frame}[fragile]{Endpoints desarrollados}{Spring Integration}
\begin{center}
\begin{tabular}{c c c c}
AMQP & File & FTP(S) & Gemfire \\
HTTP & JDBC & JMS & JMX \\
JPA & Mail & MongoDB & Redis \\
TCP & UDP & Web serv & XMPP
\end{tabular}
\end{center}
\end{frame}

\begin{frame}{Tipos de patrones}
\includegraphics[width=0.9\linewidth]{tiposPatrones}
\end{frame}

\section{Cierre}
\subsection{Palabras finales}

\begin{frame}{Conclusiones}
\begin{itemize}[<+->]
\item Los patrones ayudan a tener un lenguaje en común
\item Sirven para ordenar las ideas antes de empezar a programar
\item No es necesario usar una implementación
\item La invitación a leer los libros ``Spring Integration in action'' y ``Enterprise Integration Patterns'' 
\end{itemize}
\end{frame}

\begin{frame}{Referencias}
\begin{center}
Sitios de referencia\\
\href{http://www.eaipatterns.com/}{Enterprise Integration Patterns} \\
\href{http://camel.apache.org/}{Apache Camel} \\
\href{http://projects.spring.io/spring-integration/}{Spring Integration} \\
Libros \\
\href{https://www.dropbox.com/s/gwa5p1edxpgudcz/Manning.Spring.Integration.in.Action.Sep.2012.pdf}{Spring Integration In Action, Manning 2012}  \\
\href{https://www.dropbox.com/s/zd9uft4ygbclehn/Addison.Wesley.Enterprise.Integration.Patterns.pdf}{Enterprise Integration Patterns, Addison Wesley 2004} \\
\href{https://www.dropbox.com/s/gjfegd85cvih78a/Manning.Camel.in.Action.Dec.2010.pdf}{Apache Camel In Action, Manning 2011} \\
Proyectos en Despegar \\
\href{http://gitlab.despegar.it/mail-checker/mail-checker}{mailSender en GitLab} \\
Ejemplos \\
\href{https://github.com/spring-projects/spring-integration-samples}{Ejemplos Sp Integration} \\
\href{http://camel.apache.org/examples.html}{Ejemplos Apache Camel}
\end{center}
\end{frame}

\begin{frame}{Preguntas}
\begin{itemize}
\item ¿Se puede describir cualquier proceso con este modelo de mensajes?
\end{itemize}
\end{frame}

\begin{frame}{¡Gracias!}
\end{frame}
\end{document}